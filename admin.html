<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bleoo Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { royal: '#002147', gold: '#FDBE11' }, fontFamily: { mono: ['Consolas', 'Monaco', 'monospace'] } } } }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .glass { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .tab-btn.active { border-bottom: 3px solid #FDBE11; color: #FDBE11; background: rgba(253, 190, 17, 0.05); }
        .shake { animation: shake 0.4s ease-in-out; border-color: #ef4444 !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-royal">
        <div class="glass p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <h1 class="text-2xl font-bold text-gold tracking-widest mb-6">ADMIN ACCESS</h1>
            <form id="login-form">
                <input type="password" id="admin-pass" class="w-full bg-black/30 border border-gray-600 rounded px-4 py-3 mb-4 text-center focus:border-gold outline-none" placeholder="Enter Code" required>
                <button type="submit" class="w-full bg-gold text-royal font-bold py-2 rounded">LOGIN</button>
            </form>
            <p id="login-msg" class="text-xs text-red-400 mt-4 h-4"></p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-content" class="hidden min-h-screen pb-20">
        <nav class="bg-royal border-b border-gray-800 sticky top-0 z-50">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold">BLEOO <span class="text-gold">ADMIN</span></h1>
                <div class="flex gap-2 text-xs md:text-sm font-bold">
                    <button onclick="switchTab('logs')" id="tab-logs" class="tab-btn active px-4 py-2 rounded transition">LOGS</button>
                    <button onclick="switchTab('brain')" id="tab-brain" class="tab-btn px-4 py-2 rounded transition text-gray-400">BRAIN</button>
                    <button onclick="switchTab('students')" id="tab-students" class="tab-btn px-4 py-2 rounded transition text-gray-400">STUDENTS</button>
                </div>
                <button onclick="logout()" class="text-xs text-gray-400 hover:text-white">EXIT</button>
            </div>
        </nav>

        <main class="container mx-auto px-4 py-8">
            <!-- LOGS -->
            <div id="view-logs" class="animate-fade-in">
                <button onclick="fetchLogs()" class="mb-4 px-3 py-1 bg-gray-800 text-xs rounded border border-gray-600">Refresh</button>
                <div id="logs-container" class="grid gap-3 max-w-4xl mx-auto"></div>
            </div>

            <!-- KNOWLEDGE BASE -->
            <div id="view-brain" class="hidden animate-fade-in">
                <div class="grid lg:grid-cols-3 gap-8">
                    <div class="glass p-6 rounded-xl h-fit">
                        <h2 class="text-gold font-bold mb-4">Add Knowledge</h2>
                        <form id="brain-form" class="space-y-3">
                            <input type="text" id="k-topic" placeholder="Topic" class="w-full bg-gray-800 p-2 rounded border border-gray-600" required>
                            <select id="k-category" class="w-full bg-gray-800 p-2 rounded border border-gray-600">
                                <option>General</option><option>History</option><option>Academics</option>
                            </select>
                            <textarea id="k-content" rows="3" placeholder="Fact..." class="w-full bg-gray-800 p-2 rounded border border-gray-600" required></textarea>
                            <button class="w-full bg-gold text-royal font-bold py-2 rounded">SAVE</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 space-y-3" id="knowledge-list"></div>
                </div>
            </div>

            <!-- STUDENTS -->
            <div id="view-students" class="hidden animate-fade-in">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-bold">Student Database</h2>
                    <button onclick="downloadStudentCSV()" class="bg-green-600 text-white px-4 py-2 rounded text-xs font-bold">EXPORT EXCEL</button>
                </div>
                <div class="glass rounded-xl overflow-hidden">
                    <table class="w-full text-left text-sm text-gray-300">
                        <thead class="bg-black/30 text-gold text-xs uppercase">
                            <tr><th class="p-4">Name</th><th class="p-4">Index</th><th class="p-4">Class</th><th class="p-4">Action</th></tr>
                        </thead>
                        <tbody id="student-list" class="divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '/api';
        let studentData = [];

        // Auth
        if (sessionStorage.getItem('bleoo_token')) showDashboard();

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pass = document.getElementById('admin-pass').value;
            const res = await fetch(`${API_BASE}/admin/login`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: pass })
            });
            const data = await res.json();
            if (data.success) {
                sessionStorage.setItem('bleoo_token', data.token);
                showDashboard();
            } else {
                const msg = document.getElementById('login-msg');
                msg.innerText = "Invalid Password";
                setTimeout(() => msg.innerText = "", 2000);
            }
        });

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');
            fetchLogs();
        }
        function logout() { sessionStorage.removeItem('bleoo_token'); location.reload(); }

        // Tabs
        function switchTab(tab) {
            ['logs', 'brain', 'students'].forEach(t => {
                document.getElementById('view-' + t).classList.add('hidden');
                document.getElementById('tab-' + t).classList.remove('active', 'text-gold');
                document.getElementById('tab-' + t).classList.add('text-gray-400');
            });
            document.getElementById('view-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('active', 'text-gold');

            if(tab === 'brain') fetchKnowledge();
            if(tab === 'students') fetchStudents();
        }

        // Logs
        async function fetchLogs() {
            const res = await fetch(`${API_BASE}/logs`);
            const data = await res.json();
            document.getElementById('logs-container').innerHTML = data.map(l => `
                <div class="glass p-4 rounded border border-gray-700">
                    <div class="text-[10px] text-gray-500 mb-1">${new Date(l.timestamp).toLocaleString()}</div>
                    <div class="text-white mb-1">User: ${l.userMessage}</div>
                    <div class="text-gold text-sm">AI: ${l.botReply}</div>
                </div>
            `).join('');
        }

        // Knowledge
        async function fetchKnowledge() {
            const res = await fetch(`${API_BASE}/knowledge`);
            const data = await res.json();
            document.getElementById('knowledge-list').innerHTML = data.map(k => `
                <div class="bg-gray-800 p-3 rounded flex justify-between items-center group">
                    <div><span class="text-xs text-gold border border-gold px-1 rounded mr-2">${k.category}</span>${k.topic}</div>
                    <button onclick="deleteItem('knowledge', '${k._id}')" class="text-red-500 opacity-0 group-hover:opacity-100">âœ•</button>
                </div>
            `).join('');
        }

        document.getElementById('brain-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await fetch(`${API_BASE}/knowledge`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    topic: document.getElementById('k-topic').value,
                    category: document.getElementById('k-category').value,
                    content: document.getElementById('k-content').value
                })
            });
            e.target.reset(); fetchKnowledge();
        });

        // Students
        async function fetchStudents() {
            const res = await fetch(`${API_BASE}/students`);
            studentData = await res.json();
            document.getElementById('student-list').innerHTML = studentData.map(s => `
                <tr class="hover:bg-white/5">
                    <td class="p-4 font-bold">${s.fullName}</td>
                    <td class="p-4 font-mono text-gold">${s.indexNumber}</td>
                    <td class="p-4 text-xs text-gray-400">${s.year} - ${s.program}</td>
                    <td class="p-4"><button onclick="deleteItem('students', '${s._id}')" class="text-red-400">Del</button></td>
                </tr>
            `).join('');
        }

        async function deleteItem(type, id) {
            if(confirm("Delete this?")) {
                await fetch(`${API_BASE}/${type}/${id}`, { method: 'DELETE' });
                if(type === 'knowledge') fetchKnowledge(); else fetchStudents();
            }
        }

        function downloadStudentCSV() {
            if(studentData.length === 0) return alert("No data");
            const headers = ["Name,Index,Year,Program,House"];
            const rows = studentData.map(s => `"${s.fullName}","${s.indexNumber}","${s.year}","${s.program}","${s.house}"`);
            const blob = new Blob([headers.concat(rows).join("\n")], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a"); a.href = url; a.download = "students.csv"; a.click();
        }
    </script>
</body>
</html>