<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bleoo Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { royal: '#002147', gold: '#FDBE11' } }
            }
        }
    </script>
    <style>
        .glass { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(255,255,255,0.1); }
        .tab-btn.active { color: #FDBE11; border-bottom: 2px solid #FDBE11; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans">

    <!-- NAV -->
    <nav class="bg-royal border-b border-gray-800 sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-wider">BLEOO <span class="text-gold">ADMIN</span></h1>
            <div class="flex gap-6 text-sm font-bold">
                <button onclick="switchTab('logs')" id="tab-logs" class="tab-btn active pb-1 transition">CHAT LOGS</button>
                <button onclick="switchTab('brain')" id="tab-brain" class="tab-btn pb-1 transition text-gray-400 hover:text-white">KNOWLEDGE BASE</button>
            </div>
            <a href="index.html" class="text-xs text-gray-400 hover:text-white">EXIT</a>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-8">

        <!-- VIEW 1: CHAT LOGS -->
        <div id="view-logs">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Live Feed</h2>
                <button onclick="fetchLogs()" class="bg-gray-800 px-3 py-1 rounded text-sm hover:bg-gray-700">Refresh</button>
            </div>
            <div id="logs-container" class="space-y-3">
                <p class="text-gray-500">Loading logs...</p>
            </div>
        </div>

        <!-- VIEW 2: KNOWLEDGE BASE -->
        <div id="view-brain" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Input Column -->
                <div class="space-y-6">
                    <!-- Manual Form -->
                    <div class="glass p-6 rounded-xl">
                        <h3 class="text-gold font-bold mb-4">Add Single Fact</h3>
                        <form id="brain-form" class="space-y-3">
                            <input type="text" id="k-topic" placeholder="Topic (e.g. Fees)" class="w-full bg-black/30 border border-gray-700 rounded p-2 text-sm text-white" required>
                            <select id="k-category" class="w-full bg-black/30 border border-gray-700 rounded p-2 text-sm text-white">
                                <option>General</option>
                                <option>History</option>
                                <option>Academics</option>
                                <option>Sports</option>
                            </select>
                            <textarea id="k-content" rows="3" placeholder="Content..." class="w-full bg-black/30 border border-gray-700 rounded p-2 text-sm text-white" required></textarea>
                            <button type="submit" class="w-full bg-gold text-royal font-bold py-2 rounded hover:bg-yellow-500 transition">SAVE</button>
                        </form>
                    </div>

                    <!-- CSV Upload -->
                    <div class="glass p-6 rounded-xl border-t-4 border-blue-500">
                        <h3 class="text-blue-400 font-bold mb-2">CSV Bulk Import</h3>
                        <p class="text-xs text-gray-400 mb-3">Format: Topic, Category, Content</p>
                        <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleCSV(this)">
                        <label for="csvInput" class="block w-full text-center border border-dashed border-gray-600 py-3 rounded cursor-pointer hover:border-blue-400 hover:text-blue-400 text-sm text-gray-500 transition">
                            Select CSV File
                        </label>
                        <div id="csv-status" class="mt-2 text-xs text-center text-gray-300"></div>
                    </div>
                </div>

                <!-- Data List -->
                <div class="lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Database Records</h2>
                        <span id="k-count" class="text-xs bg-gray-800 px-2 py-1 rounded">0</span>
                    </div>
                    <div id="knowledge-list" class="space-y-2 h-[600px] overflow-y-auto pr-2">
                        <p class="text-gray-500">Loading data...</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        const API_BASE = '/api';

        // --- AUTH ---
        if (prompt("Password:") !== "bleoo1931") window.location.href = "index.html";
        else { fetchLogs(); fetchKnowledge(); }

        function switchTab(tab) {
            document.getElementById('view-logs').classList.add('hidden');
            document.getElementById('view-brain').classList.add('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-gold'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.add('text-gray-400'));

            document.getElementById('view-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('active', 'text-gold');
        }

        // --- FETCH LOGS ---
        async function fetchLogs() {
            const container = document.getElementById('logs-container');
            try {
                const res = await fetch(`${API_BASE}/logs`);
                if (!res.ok) throw new Error("Server Error");
                const data = await res.json();

                if (!Array.isArray(data)) throw new Error("Invalid Data Format");
                if (data.length === 0) { container.innerHTML = "<p class='text-gray-500'>No logs yet.</p>"; return; }

                container.innerHTML = data.map(log => `
                    <div class="glass p-4 rounded-lg flex flex-col gap-2">
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>User</span>
                            <span>${new Date(log.timestamp).toLocaleString()}</span>
                        </div>
                        <div class="text-white text-sm bg-black/20 p-2 rounded border-l-2 border-gold">${log.userMessage}</div>
                        <div class="text-gray-400 text-sm pl-2 border-l-2 border-blue-500">${log.botReply}</div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = `<p class="text-red-500">Error loading logs. Is server running?</p>`;
            }
        }

        // --- FETCH KNOWLEDGE ---
        async function fetchKnowledge() {
            const list = document.getElementById('knowledge-list');
            try {
                const res = await fetch(`${API_BASE}/knowledge`);
                if (!res.ok) throw new Error("Server Error");
                const data = await res.json();

                if (!Array.isArray(data)) throw new Error("Invalid Data");

                document.getElementById('k-count').innerText = data.length;
                list.innerHTML = data.map(k => `
                    <div class="bg-gray-800 p-3 rounded border border-gray-700 hover:border-gray-500 transition flex justify-between group">
                        <div>
                            <span class="text-[10px] bg-royal text-gold px-1 rounded uppercase">${k.category}</span>
                            <h4 class="font-bold text-sm inline ml-2">${k.topic}</h4>
                            <p class="text-xs text-gray-400 mt-1 line-clamp-1">${k.content}</p>
                        </div>
                        <button onclick="deleteFact('${k._id}')" class="text-red-500 opacity-0 group-hover:opacity-100 hover:bg-red-900/50 px-2 rounded">✕</button>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = `<p class="text-red-500">Error loading data.</p>`;
            }
        }

        // --- MANUAL SAVE ---
        document.getElementById('brain-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Saving...";

            await uploadFact(
                document.getElementById('k-topic').value,
                document.getElementById('k-category').value,
                document.getElementById('k-content').value
            );

            e.target.reset();
            btn.innerText = originalText;
        });

        async function uploadFact(topic, category, content) {
            try {
                const res = await fetch(`${API_BASE}/knowledge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, category, content })
                });
                if(res.ok) {
                    fetchKnowledge();
                } else {
                    alert("Failed to save.");
                }
            } catch(e) { console.error(e); }
        }

        async function deleteFact(id) {
            if(confirm("Delete?")) {
                await fetch(`${API_BASE}/knowledge/${id}`, { method: 'DELETE' });
                fetchKnowledge();
            }
        }

        // --- CSV HANDLER ---
        function handleCSV(input) {
            const file = input.files[0];
            if (!file) return;
            const status = document.getElementById('csv-status');
            status.innerText = "Parsing...";

            const reader = new FileReader();
            reader.onload = async (e) => {
                const lines = e.target.result.split('\n');
                let count = 0;

                for(let i=1; i<lines.length; i++) {
                    const row = lines[i].trim();
                    if(!row) continue;

                    // Basic split by comma (warning: breaks if content has commas)
                    const parts = row.split(',');
                    if(parts.length >= 3) {
                        const topic = parts[0].trim();
                        const category = parts[1].trim();
                        // Join rest as content
                        const content = parts.slice(2).join(',').trim();

                        await uploadFact(topic, category, content);
                        count++;
                        status.innerText = `Uploaded ${count}...`;
                    }
                }
                status.innerText = `✅ Done! Added ${count} items.`;
                input.value = ""; // Reset
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>